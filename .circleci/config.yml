version: 2.1

jobs:
  test_core:
    docker:
    - image: maven:3.6-jdk-8-slim
    steps:
    - checkout
    - run: mvn --projects core test

  test_ingestion:
    docker:
    - image: maven:3.6-jdk-8-slim
    steps:
    - checkout
    - run: mvn --projects ingestion test

  test_serving:
    docker:
    - image: maven:3.6-jdk-8-slim
    steps:
    - checkout
    - run: mvn --projects serving test

  test_cli:
    docker:
    - image: golang:1.12
    steps:
    - checkout
    - run: go test ./cli/feast/...

  build_and_push_core:
    docker:
    - image: google/cloud-sdk:245.0.0
    steps:
    - checkout
    - setup_remote_docker
    - run: .circleci/build_and_push_docker_image.sh us.gcr.io/kf-feast/feast-core:${CIRCLE_SHA1}

  build_and_push_serving:
    docker:
    - image: google/cloud-sdk:245.0.0
    steps:
    - checkout
    - setup_remote_docker
    - run: .circleci/build_and_push_docker_image.sh us.gcr.io/kf-feast/feast-serving:${CIRCLE_SHA1}

  build_and_push_cli:
    docker:
    - image: golang:1.12
    steps:
    - checkout
    - run: .circleci/build_and_push_cli.sh gs://feast-templocation-kf-feast/build/${CIRCLE_SHA1}/cli/feast

  integration_test:
    docker:
    - image: python:3.7
    steps:
    - checkout 
    - run: .circleci/install_integration_test_tools.sh
    - run: .circleci/install_feast.sh
    - run: .circleci/run_batch_import_and_validate.sh
    - run: .circleci/run_streaming_import_and_validate.sh
    - run: 
        command: .circleci/uninstall_feast.sh
        when: always

  # install_feast:
  #   docker:
  #   - image: devth/helm:v2.13.1
  #   steps:
  #   - checkout 
  #   - run: .circleci/install_feast.sh

  # integration_test:
  #   docker:
  #   - image: python:3.7
  #   steps:
  #   - checkout
  #   # - run: .circleci/run_batch_import_and_validate.sh
  #   - run: .circleci/run_streaming_import_and_validate.sh

  # uninstall_feast:
  #   docker:
  #   - image: devth/helm:v2.13.1
  #   steps:
  #   - checkout
  #   - run: 
  #       command: .circleci/uninstall_feast.sh

workflows:
  feast_ci:
    jobs:
    # - test_core
    # - test_ingestion
    # - test_serving
    # - test_cli
    # - build_and_push_core
    # - build_and_push_serving
    # - build_and_push_cli

    - integration_test